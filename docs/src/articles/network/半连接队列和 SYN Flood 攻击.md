[toc]

# 半连接队列和 SYN Flood 攻击

## 1. 半连接队列

三次握手时，服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全简历其连接，服务器会把此种状态下请求连接放在一个队列里面，我们把这种队列称之为半连接队列。

当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。

这里补充一点关于 SYN-ACK 重传次数的问题： 服务器发送完 SYN-ACK 包，如果未收到客户端确认包，服务器进行首次重传，等待一段时间仍未收到客户端确认包，进行第二次重传。如果重传次数超过系统规定的最大重传次数，系统将改连接信息从半连接队列中删除。注意，每次重传等待的时间不一定相同，一般会是指数增长，例如间隔时间为1s, 2s,4s,8s...

## 2. SYN 攻击

服务器端的资源分配是在二次握手时分配的，而客户端的资源时再完成三次握手时分配的，所以服务器容易受到 `SYN 洪泛攻击`

> SYN 攻击是一种典型的 Dos / DDoS 攻击
>
> SYN 攻击就是 Client 在短时间内伪造大量不存在的 IP  地址,并向 Server 不断发送 SYN 包， Server 则 回复确认包，并等待 Client 确认，由于源地址不存在，因此 Server 需要不断重发直至超时，这些伪造的 SYN包将长时间占用未连接队列，导致正常的 SYN 请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪

检测 SYN 攻击非常的方便，当你在服务器上看到大量的半连接状态时，特别是源 IP 地址是随机的，基本上就可以断定这是一次 SYN 攻击。 在 Linux/Unix 上可以使用系统自带的 `netstat` 命令来检测 SYN 攻击

```bash
netstat -n -p TCP | grep SYNC_RECV
```

常见的防御 SYN 攻击的方法有如下几种：

- 缩短超时（SYN Timeout） 时间
- 增加最大半连接数
- 过滤网关防护
- SYN cookies 技术